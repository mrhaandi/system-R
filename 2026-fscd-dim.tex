\documentclass[a4paper,USenglish,cleveref, autoref, thm-restate]{lipics-v2021}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{bussproofs}
\usepackage{graphicx}
\usepackage{lmodern}
\usepackage{microtype}
\usepackage{csquotes}
\usepackage{xcolor}
\usepackage{hyperref}
\usepackage{stmaryrd}
\usepackage{xspace}
%This is a template for producing LIPIcs articles. 
%See lipics-v2021-authors-guidelines.pdf for further information.
%for A4 paper format use option "a4paper", for US-letter use option "letterpaper"
%for british hyphenation rules use option "UKenglish", for american hyphenation rules use option "USenglish"
%for section-numbered lemmas etc., use "numberwithinsect"
%for enabling cleveref support, use "cleveref"
%for enabling autoref support, use "autoref"
%for anonymizing the authors (e.g. for double-blind review), add "anonymous"
%for enabling thm-restate support, use "thm-restate"
%for enabling a two-column layout for the author/affilation part (only applicable for > 6 authors), use "authorcolumns"
%for producing a PDF according the PDF/A standard, add "pdfa"

%\pdfoutput=1 %uncomment to ensure pdflatex processing (mandatatory e.g. to submit to arXiv)
%\hideLIPIcs  %uncomment to remove references to LIPIcs series (logo, DOI, ...), e.g. when preparing a pre-final version to be uploaded to arXiv or another public repository

%\graphicspath{{./graphics/}}%helpful if your graphic files are in another directory

\bibliographystyle{plainurl}% the mandatory bibstyle

\title{A Bounded Parallel Intersection Type System}

%\titlerunning{Dummy short title} %optional, please use if title is longer than one line

\author{Andrej Dudenhefner}{TU Dortmund University, Germany}{andrej.dudenhefner@cs.tu-dortmund.de}{https://orcid.org/0000-0003-1104-444X}{}{}%mandatory, please use full name; only 1 author per \author macro; first two parameters are mandatory, other parameters can be empty. Please provide at least the name of the affiliation and the country. The full address is optional. Use additional curly braces to indicate the correct name splitting when the last name consists of multiple name parts.

\author{Aleksy Schubert}{University of Warsaw, Poland}{alx@mimuw.edu.pl}{}{}{}

\author{Jakob Rehof}{TU Dortmund University, Germany}{jakob.rehof@cs.tu-dortmund.de}{}{}{}

\authorrunning{A. Dudenhefner, A. Schubert, and J. Rehof} %mandatory. First: Use abbreviated first/middle names. Second (only in severe cases): Use first author plus 'et al.'

\Copyright{Andrej Dudenhefner, Aleksy Schubert, and Jakob Rehof} %mandatory, please use full first names. LIPIcs license is "CC-BY";  http://creativecommons.org/licenses/by/3.0/

\ccsdesc[500]{Theory of computation~Type theory} %mandatory: Please choose ACM 2012 classifications from https://dl.acm.org/ccs/ccs_flat.cfm 

\keywords{type system, lambda-calculus, intersection types, inhabitation, complexity} %mandatory; please add comma-separated list of keywords

\category{} %optional, e.g. invited paper

%\relatedversion{} %optional, e.g. full version hosted on arXiv, HAL, or other respository/website
%\relatedversiondetails[linktext={opt. text shown instead of the URL}, cite=DBLP:books/mk/GrayR93]{Classification (e.g. Full Version, Extended Version, Previous Version}{URL to related version} %linktext and cite are optional

%\supplement{}%optional, e.g. related research data, source code, ... hosted on a repository like zenodo, figshare, GitHub, ...
%\supplementdetails[linktext={opt. text shown instead of the URL}, cite=DBLP:books/mk/GrayR93, subcategory={Description, Subcategory}, swhid={Software Heritage Identifier}]{General Classification (e.g. Software, Dataset, Model, ...)}{URL to related version} %linktext, cite, and subcategory are optional

%\funding{(Optional) general funding statement \dots}%optional, to capture a funding statement, which applies to all authors. Please enter author specific funding statements as fifth argument of the \author macro.

%\acknowledgements{I want to thank \dots}%optional

%\nolinenumbers %uncomment to disable line numbering

%Editor-only macros:: begin (do not touch as author)%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\EventEditors{John Q. Open and Joan R. Access}
\EventNoEds{2}
\EventLongTitle{42nd Conference on Very Important Topics (CVIT 2016)}
\EventShortTitle{CVIT 2016}
\EventAcronym{CVIT}
\EventYear{2016}
\EventDate{December 24--27, 2016}
\EventLocation{Little Whinging, United Kingdom}
\EventLogo{}
\SeriesVolume{42}
\ArticleNo{23}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\DeclareMathOperator{\dom}{dom}
\DeclareMathOperator{\var}{var}
\DeclareMathOperator{\rank}{rank}
\DeclareMathOperator{\form}{form}

\newcommand{\rbar}[1]{\mathrel{\bar{#1}}}
\newcommand{\edmark}{{\color{red} mark} }

\begin{document}

\maketitle

\begin{abstract}
We introduce a new presentation of the intersection type discipline in which typing judgments derive \emph{vectors} of types rather than single types.
The system uses \emph{binary relations} to control the flow of information between coordinates of these vectors.
We refer to this presentation as \emph{system \textbf{R}}.
The maximal length of type vectors assigned to variables serves as a reasonable notion of \emph{dimension} for system \textbf{R}, which allows for a natural stratification into fragments of bounded dimension.

The present system lies strictly between two known bounded-dimensional systems: 
the multiset-dimensional system, for which inhabitation is \textsf{EXPSPACE}-complete, and the set-dimensional system, for which inhabitation is undecidable.
Our main result is that inhabitation in bounded system \textbf{R} is decidable in \textsf{2-EXPTIME}, while for each fixed dimension, inhabitation is decidable in \textsf{EXPTIME}.
This result is based on a subformula property restricting the inhabitant search space.
Unlike in traditional intersection type systems, the proof of the subformula property requires careful treatment of the additional information flow management capabilities.

Finally, we argue that system \textbf{R} and its stratification is a valid presentation of the intersection type discipline.
First, by proving the subject reduction property for system \textbf{R} in each bounded dimension, and second, by establishing a correspondence with the classical intersection type system of Barendregt, Coppo, and Dezani-Ciancaglini.
\end{abstract}


\section{Introduction}

 Intersection type systems \cite{cdv81,BarendregtCD83} are important in  the theory of typed $\lambda$-calculus and programming languages \cite{BDS13}. Such systems are highly expressive, characterizing deep semantic properties of $\lambda$-terms including normalization and solvability properties \cite{BDS13}. Due to their enormous expressive power, the classical type theoretical decision problems, typability and inhabitation, are undecidable for such systems. It is therefore of interest to investigate bounding principles for intersection type systems in order to obtain decidable fragments, which may be useful for applications (for example, type checking or program synthesis) or interesting for understanding the borderline between decidability and undecidability or the complexity of bounded fragments. 
 
 In \cite{DudenhefnerR17} a notion of {\em dimensional bound} was introduced for intersection type derivations. Intuitively, dimension measures the maximal width (number of components) of intersection types introduced for subterms in a derivation. Dimension can be measured in two ways, depending on whether width is measured over sets of types or multisets of types. The former corresponds to the standard, idempotent treatment of intersection types, the latter corresponds to a non-idempotent treatment. Relative to each measurement system we considered inhabitation under dimensional bound: given a type and a dimensional bound, does there exist a term having the type in the given dimension?
 A key result of \cite{DudenhefnerR17} is that the dimension-bounded inhabitation problem is undecidable in set-theoretic dimension (\cite{DudenhefnerR17}, Theorem~28) but decidable and \textsf{EXPSPACE}-complete in multiset dimension (\cite{DudenhefnerR17}, Theorem~34). For fixed dimensional parameter, the latter problem is
 \textsf{PSPACE}-complete.
The main previous result concerning decidable fragments of the inhabitation problem for intersection types had been given by Urzyczyn \cite{urzy09}, showing that the
problem is decidable and \textsf{EXPSPACE}-complete in rank $2$, and
undecidable in all ranks $k$ for $k \ge 3$ (here referring to Leivantâ€™s
notion of rank \cite{le83}). Because all typings in rank $2$ are derivable in linear multiset dimension (meaning dimension $n$ for an intersection type with $n$ components, see \cite{DudenhefnerR17} Proposition~23), the result for bounded multiset dimension represented a significant generalization of the rank $2$ borderline (typings in bounded multiset dimensions span across all ranks).

In this paper we introduce and study a system with {\em bounded parallel intersection} (BPI for short) providing a strict generalization of the multiset dimensional system of \cite{DudenhefnerR17}, extending (and deepening the analysis of) decidable inhabitation under dimensional bound. Intuitively, the BPI system occupies a position between the set-theoretic and the multiset dimensional systems of \cite{DudenhefnerR17}, employing a combination of intersection types represented as vectors of types (which are non-idempotent) and as sets of types (which are idempotent). A technical novelty of the system is the use of relations specifying type vector transformations that, intuitively, capture information flow between types in a derivation, and which mediate between vectors of types and sets of types. Dimensionality in this system is measured by the maximal length of vectors of intersection types (sets of types) that can be used to type a variable. Our main technical result is that inhabitation in bounded dimension is decidable in 
\textsf{2-EXPTIME}, and for each fixed dimension, inhabitation is decidable in \textsf{EXPTIME}. We have corresponding lower bounds of \textsf{EXPSPACE} and \textsf{PSPACE}, respectively, and leave open the problem of closing the gaps.

\subparagraph*{Similar systems}
\begin{itemize}
\item The system $\lambda^{\text{CIL}}$ by Wells et al.~\cite{WellsDMT02} (see \cite{WellsH02} for a simplified version of
  the system) is a system in Church style with explicit type
  annotations in $\lambda$-binders where different derivations for the
  same subterm are managed by means of records. A record of types with
  labels from $I$ is derived here by a record of terms of
  corresponding labels from $I$.
\item The proof system ISL presented by Pimentel, Ronchi Della Rocca,
  and Roversi \cite{PimentelRR12} features independent derivations in
  tuples led according to the same proof rules. Effectively this works
  like an intersection type system with vectors.
  However, the system does not have proof terms. A version of the proof system formulated
  in terms of a sequent calculus is presented in \cite{RoccaSSV10}.
\end{itemize}

\subparagraph*{Comparison with the Sequent Calculus for Intersection Logic}

The line of research on Intersection Logic~\cite{ronchi,ronchi10,ronchi12} inspired the development of a vector-based sequent calculus, which we refer to as $(\vdash_{\textnormal{IL}})$, along with corresponding Kripke semantics~\cite{DudenhefnerU21} for Intersection Logic.
Proof search in $(\vdash_{\textnormal{IL}})$ corresponds to inhabitation in $(\vdash_{\textnormal{BCD}})$.
It is natural to compare fragments of $(\vdash_{\textnormal{IL}})$ in which the length of vectors is bounded by $k$, which we refer to as $(\vdash_{\textnormal{IL}}^k)$, to the presented dimensionally bounded system.

The construction in the proof of Lemma~\ref{lem:exp_blowup_1} will not induce arbitrary large vectors in $(\vdash_{\textnormal{IL}}^k)$.
This is because $(\vdash_{\textnormal{IL}}^k)$ has subtyping and also allows sets of types to appear at the right of the arrow type construction.
Therefore, $(\vdash_{\textnormal{IL}}^k)$ does not require any intersection introduction for derivations occurring in the construction in the proof of Lemma~\ref{lem:exp_blowup_1}.

The most important difference between $(\vdash_{\textnormal{IL}}^k)$ and $(\vdash_k)$ is that reorganization of vector coordinates in premises is realized via inverse images of surjective functions (see rule (R)~\cite[Figure~1]{DudenhefnerU21}).
For example, for the function $f$ such that $f(1) = 1 = f(2)$ the inverse image of the vector $(\{a,b\})$ under $f$ is $f^{-1}((\{a,b\})) = (\{a,b\}, \{a,b\})$.
Information in premises is duplicated and there is no granular control over the \emph{relevant} part of assumptions.
Establishing such granular control can be realized via relations, generalizing functions, which is the aim of the system $(\vdash_k)$ in the present work.

\subparagraph*{Dissimilar systems}
\begin{itemize}
\item The system by Luigi Liquori and Simona Ronchi della Rocca
  \cite{LiquoriR07} is a system with explicit annotations at
  $\lambda$-binders. It introduces  terms in which variables in
  binders are annotated with indices. Then these indices serve as
  pointers to binders in derivations, and the binders in derivations
  contain types.
\end{itemize}

\subparagraph*{Paper organization} The present work is structured as follows: 
\begin{description}
\item[Section~\ref{sec:system}:] Definition of system \textbf{R} with a dimension bound~(Definition~\ref{def:bounded-type-system}) and key properties such as weakening (Lemma~\ref{lem:weak}), substitution lemma (Lemma~\ref{lem:substitution-lemma}), and subject reduction (Lemma~\ref{lem:subject-reduction}).
\item[Section~\ref{sec:iff_BCD}:] Correspondence with the traditional intersection type system of Barendregt, Coppo, and Dezani-Ciancaglini (Theorem~\ref{theorem:bcd}).
\item[Section~\ref{sec:inh_dec}:] \textsf{2-EXPTIME} decidability of inhabitation in bounded dimension (Theorem~\ref{thm:upper_complexity_bound}) and \textsf{EXPTIME} decidability of inhabitation in fixed dimension (Theorem~\ref{thm:upper_complexity_bound_fixed}).
\item[Section~\ref{sec:mset_dim}:] Comparison with the multiset-dimensional system (Lemma~\ref{lem:multiset_to_vector}, Lemma~\ref{lem:exp_blowup_1}, and Lemma~\ref{lem:exp_blowup_2}) and \textsf{EXPSPACE}-hardness of inhabitation in bounded dimension (Corollary~\ref{cor:inh_lower_bound}).
\item[Section~\ref{sec:conclusion}:] Concluding remarks.
\end{description}



\section{System \textbf{R}}
\label{sec:system}

We denote \emph{intersection types} by $A, B$, finite sets of intersection types by $\sigma, \tau$, and \emph{type atoms} by $a, b$.

\begin{definition}[Intersection Types]
\label{def:itypes} ~

$\begin{array}{rcl}
%\mbox{Types} \ni & 
A, B &::=& a \mid \sigma \to A\\
%\{\}\mbox{-Types}\ni &
\sigma, \tau &::=& \{A_1, \ldots, A_n\} \text{ where } n \geq 0
\end{array}$
\end{definition}
Intersection types are a variant of strict types considered by van Bakel~\cite{Bakel92,Bakel04,Bakel11}.

We denote vectors of types and vectors of sets of types by $\bar{A}$ and $\bar{\sigma}$ respectively.
If $\bar{\sigma} = (\sigma_1, \ldots, \sigma_n)$ and $\bar{A} = (A_1, \ldots, A_n)$, then $\bar{\sigma} \Rightarrow \bar{A} = (\sigma_1 \to A_1, \ldots, \sigma_n \to A_n)$, in particular $()\Rightarrow()=()$. We write $\bar{A}_{[i]}$ for $A_i$ and $\bar{\sigma}_{[i]}$ for $\sigma_i$.
The \emph{dimension} of a vector is the number of its \emph{coordinates}, that is $\dim(A_1, \ldots, A_n) = n$.
We extend relations $\subseteq$, $\in$, and the operation $\cup$ to vectors.
\begin{definition}[Vector Extension]\label{def:vec_extension}~
    \begin{itemize}
        \item $(\sigma_1, \ldots, \sigma_n) \rbar{\subseteq} (\tau_1, \ldots, \tau_n)$ if $\sigma_1 \subseteq \tau_1, \ldots, \sigma_n \subseteq \tau_n$
        \item $(A_1, \ldots, A_n) \rbar{\in} (\sigma_1, \ldots, \sigma_n)$ if $A_1 \in \sigma_1, \ldots, A_n \in \sigma_n$
        \item $(\sigma_1, \ldots, \sigma_n) \rbar{\cup} (\tau_1, \ldots, \tau_n) := (\sigma_1 \cup \tau_1, \ldots, \sigma_n \cup \tau_n)$
        \item $(\{A_1\}, \ldots, \{A_n\})\!\!\downarrow\, := (A_1, \ldots, A_n)$
    \end{itemize}
\end{definition}

\newpage

\begin{definition}[Environment of Dimension $d$]
An \emph{environment} $\Sigma$ is a finite set of \emph{type assumptions} having the shape $x : \sigma$ for distinct term variables. An \emph{environment} $\Gamma$ of dimension $d$ is a finite set of \emph{type assumptions} having the shape $x : \bar{\sigma}$ for distinct term variables such that $\dim(\bar{\sigma}) = d$.
%$\Gamma ::=\{x_1 : \bar{\sigma_1}, \ldots, x_n : \bar{\sigma_n}\}$ where $x_i \neq x_j$ for $i \neq %j$ and $\dim(\Gamma) := \dim(\bar{\sigma_1}) = \cdots = \dim(\bar{\sigma_n}) = d$.
\end{definition}
Each environment $\Gamma$ is equipped with its dimension $\dim(\Gamma)$.
In particular, the empty environment of dimension $0$ is distinct from the empty environment of dimension $1$. 

We may extend an environment $\Gamma$ by an additional assumption $x : \bar{\sigma}$, written $\Gamma, x : \bar{\sigma}$, where $\dim(\bar{\sigma}) = \dim(\Gamma)$ and $x$ does not appear in any assumption in $\Gamma$.
The \emph{domain} of an environment $\Gamma$ is given by $\dom(\Gamma) = \{ x \mid (x : \bar{\sigma}) \in \Gamma \text{ and } \bar{\sigma} \neq   (\emptyset, \ldots, \emptyset)\}$.
When $(x:\bar{\sigma})\in\Gamma$ we write $\Gamma(x)$ for $\bar{\sigma}$.
We identify $\Gamma$ and $\Gamma, x : (\emptyset, \ldots, \emptyset)$, that is $\Gamma(y) = (\emptyset, \ldots, \emptyset)$ iff $y \not\in \dom(\Gamma)$ for any term variable $y$.

Similarly to vectors, we extend the relation $\subseteq$, the operation $\cup$, and coordinate indexing to environments.

\begin{definition}[Environment Extension]\label{def:env_extension}
Let $\Gamma, \Delta$ be environments such that $\dim(\Gamma) {=} \dim(\Delta)$.
    \begin{itemize}
        \item $\Gamma \subseteq \Delta$ if $\Gamma(x) \rbar{\subseteq} \Delta(x)$ for  $x \in \dom(\Gamma)$
        \item $(\Gamma\cup\Delta)(x) := \Gamma(x) \rbar{\cup} \Delta(x)$
        \item $\Gamma_{[i]} := \{ x:\bar{\sigma}_{[i]} \mid (x:\bar{\sigma})\in\Gamma\}$
    \end{itemize}
\end{definition}

The original feature of the system presented in this paper is the management of flow of types between vectors by means of relations. We extend notation in the paper~\cite{DudenhefnerU21} from surjective functions to binary relations, and define type vector transformations as follows.

\begin{definition}[Type Vector Transformation]
Let $R \subseteq \{1, \ldots, n\} \times \{1, \ldots, m\}$ be a binary relation where $n, m \geq 0$.
\begin{itemize}
%\item $i\,R\,j$ means $(i,j)\in R$
\item $R((A_1, \ldots, A_n)) := (\tau_1, \ldots, \tau_m)$ where $\tau_i = \{A_j \mid j \, R\, i\}$
\item $R((\sigma_1, \ldots, \sigma_n)) := (\tau_1, \ldots, \tau_m)$ where $\tau_i = \bigcup \{\sigma_j \mid j \, R\, i\}$
\item $R(\{x_1 : \bar{\sigma}_1, \ldots, x_l : \bar{\sigma}_l\}) := \{x_1 : R(\bar{\sigma}_1), \ldots, x_l : R(\bar{\sigma}_l)\}$
\end{itemize}
\end{definition}

\begin{example}
For $R = \{(1, 1), (1, 3), (3, 2), (3, 3)\}$ we have $R((a, b, c)) = (\{a, b\}, \{\}, \{a, c\})$.
\end{example}

\begin{definition}\label{def:rel-defs}
Let $R\subseteq \{1, \ldots, n\} \times \{1, \ldots, m\}$ be a relation.
\begin{itemize}

    \item $R$ is \emph{left-total} when for each $i\in \{1, \ldots, n\}$ there is a $j$ such that $i\,R\,j$
    \item $R$ is \emph{right-total} when for each $j\in \{1, \ldots, m\}$ there is an $i$ such that $i\,R\,j$
    \item $R$ is \emph{left-unique} when for each $i\in\{1, \ldots, n\}$ there is at most one $j$ such that $i\,R\,j$
    \item $R$ is \emph{right-unique} when for each $j\in\{1, \ldots, m\}$ there is at most one $i$ such that $i\,R\,j$
\end{itemize}
\end{definition}

If a relation $R$ is right-unique and right-total, then the vector of types $R(\bar{B})\!\!\downarrow$ is well-defined.
Primary properties of vector transformations are listed in the following Lemma~\ref{lem:rel-properties}.

\begin{lemma}[Properties of Vector Transformations]
\label{lem:rel-properties}~
\begin{enumerate}
    \item\label{prop:rel-properties:monotone} For two binary relations $R, R' \subseteq \{1, \ldots, n\} \times \{1, \ldots, m\}$ it holds that if $R \subseteq R'$, then for all $\bar{\sigma}$ such that $\dim(\bar{\sigma}) = n$ we have $R(\bar{\sigma}) \rbar{\subseteq} R'(\bar{\sigma})$.
    \item\label{prop:rel-properties:exact} If $R(\bar{\sigma}) \rbar{\subseteq} R'(\bar{A})$ and $R$ is left-total, then there exists $R''$ such that $R''(\bar{A}) = \bar{\sigma}$.
    \item\label{prop:rel-properties:compose} If $\bar{A}$ has distinct coordinates, $R''(\bar{A}) = \bar{\sigma}$, $R(\bar{\sigma}) \rbar{\subseteq} R'(\bar{A})$, and $R$ is left-total, then $R \circ R'' \subseteq R'$.
    \item\label{prop:rel-properties:union} $R(\Gamma_1 \cup \Gamma_2) = R(\Gamma_1) \cup R(\Gamma_2)$
    \item\label{prop:rel-properties:in} If $R$ is right-unique and right-total, and $\bar{A} \rbar{\in} \bar{\sigma}$ then
        $R(\bar{A})\!\!\downarrow\, \rbar{\in} R(\bar{\sigma})$.
    \item\label{prop:rel-properties:impl} If $R$ is right-unique and right-total, then $R(\bar{\sigma} \Rightarrow \bar{A})\!\!\downarrow\, = R(\bar{\sigma}) \Rightarrow R(\bar{A})\!\!\downarrow$.
    \item\label{prop:rel-properties:saturate} If $R(\bar{\sigma}) \rbar{\subseteq} \bar{\tau}$ and $R$ is left-total, then there exists $\bar{\sigma}'$ such that $\bar{\sigma} \rbar{\subseteq} \bar{\sigma}'$, $R(\bar{\sigma}') \rbar{\subseteq} \bar{\tau}$, and for all $i \in \{1, \ldots, \dim(\bar{\sigma}')\}$ there exists $j \in \{1, \ldots, \dim(\bar{\tau})\}$ such that $\bar{\sigma}'_{[i]} = \bar{\tau}_{[j]}$.
\end{enumerate}
\end{lemma}

\begin{proof}~
    \begin{enumerate}
        \item The claim follows from $R(\bar{\sigma})_{[i]} = \bigcup \{\bar{\sigma}_{[j]} \mid j \, R\, i\} \subseteq \bigcup \{\bar{\sigma}_{[j]} \mid j \, R'\, i\} = R'(\bar{\sigma})_{[i]}$.
        \item  Consider $R'' = \{ (i, j) \mid \exists k.i\, R'\, k \mbox{ and } j\, R\, k \mbox{ and } \bar{A}_{[i]}\in\bar\sigma_{[j]}\}$.
            We have $R''(\bar{A})_{[j]} = \{ \bar{A}_{[i]} \mid i\, R''\, j \} = \{ \bar{A}_{[i]} \mid  \exists k.i\, R'\, k \mbox{ and } j\, R\, k \mbox{ and } \bar{A}_{[i]}\in\bar\sigma_{[j]}\}$.
            This set is included in $\bar\sigma_{[j]}$ as for each its element $\bar{A}_{[i]}$ we have
            $\bar{A}_{[i]}\in\bar\sigma_{[j]}$. Similarly, $\bar\sigma_{[j]}\subseteq R(\bar\sigma)_{[k]}$ for some $k$ as $R$ is left-total. As $R(\bar\sigma)_{[k]}\subseteq R'(\bar{A})_{[k]}$, each element of $\bar{\sigma}_{[j]}$ must be equal to some $\bar{A}_{[i]}$ such that $i\, R'\, k$.
        \item We have $(R \circ R'')(\bar{A}) = R(\bar{\sigma}) \rbar{\subseteq} R'(\bar{A})$.
        Since $\bar{A}$ has distinct coordinates, we obtain the claim.     
        \item Immediate from the definition.
        \item Since $R$ is right-unique and right-total, for each $i \in \{1, \ldots, \dim(R(\bar{A})\!\!\downarrow)\}$ there is exactly one $j$ such that $j\,R\,i$, and we have  $(R(\bar{A})\!\!\downarrow)_{[i]} = \bar{A}_{[j]} \in \bar{\sigma}_{[j]} \subseteq R(\bar{\sigma})_{[i]}$.
        \item Since $R$ is right-unique and right-total, we have $(R(\bar{\sigma} \Rightarrow \bar{A})\!\!\downarrow)_{[i]}\, = \bar{\sigma}_{[j]}\to\bar{A}_{[j]}$ where $j\, R\, i$ for exactly one $j$. 
        Similarly, $R(\bar{\sigma})_{[i]} =  \bar{\sigma}_{[j]}$ and %
        $(R(\bar{A})\!\!\downarrow)_{[i]} = \bar{A}_{[j]}$ where $j\, R\, i$. Consequently, we obtain $R(\bar{\sigma} \Rightarrow \bar{A})\!\!\downarrow = R(\bar{\sigma}) \Rightarrow R(\bar{A})\!\!\downarrow$.
        \item Since $R$ is left-total, for all $i \in \{1, \ldots, \dim(\bar{\sigma})\}$ there exists $j \in \{1, \ldots, \dim(\bar{\tau})\}$ such that $i\,R\,j$, for which we set $\bar{\sigma}'_{[i]} := \bar{\tau}_{[j]}$, satisfying the required properties.\qedhere
    \end{enumerate}
\end{proof}

Judgments in the following \emph{system \textbf{R}} with \emph{dimension bound} $k$ are of shape $\Gamma \vdash_k t : \bar{A}$ such that $\dim(\Gamma) = \dim(\bar{A})$.

\begin{definition}[System \textbf{R} with Dimension Bound $k$]
\label{def:bounded-type-system}
~\\

\begin{minipage}{\textwidth}
\centering
%\begin{tabular}{c}

\hspace{-5em}%
{\RightLabel{\textnormal{(Ax)}}
\AxiomC{$\bar{A} \rbar{\in} \bar{\sigma}$}
\AxiomC{$\dim(\bar{A}) \leq k$}
\BinaryInfC{$\Gamma, x : \bar{\sigma} \vdash_k x : \bar{A}$}
\DisplayProof}
~\\[2ex]
{\RightLabel{\textnormal{($\Rightarrow$I)}}
\AxiomC{$\Gamma, x: \bar{\sigma} \vdash_k t : \bar{A}$}
\UnaryInfC{$\Gamma \vdash_k \lambda x.t : \bar{\sigma} \Rightarrow \bar{A}$}
\DisplayProof}\quad
{\RightLabel{\textnormal{($\Rightarrow$E)}}
\AxiomC{$\Gamma \vdash_{k} t : R(\bar{A}) \Rightarrow \bar{B}$}
\AxiomC{$\Delta \vdash_{k} u : \bar{A}$}
\BinaryInfC{$\Gamma \cup R(\Delta) \vdash_k t \; u : \bar{B}$}
\DisplayProof}
%\end{tabular}
\end{minipage}
\end{definition}

We may leave out the actual bound, if it is immaterial.

\begin{definition}[System \textbf{R}]
    $\Gamma \vdash t : \bar{A}$ means $\Gamma \vdash_k t : \bar{A}$ for some $k$.
\end{definition}

\begin{lemma}
The following rule is derivable:
{\RightLabel{\textnormal{($nil$)}}
\AxiomC{\phantom{1337}}
\UnaryInfC{$\emptyset \vdash_k t : ()$}
\DisplayProof}.
\end{lemma}

\begin{proof}
We proceed by induction on $t$.
\begin{description}
    \item[Case $t = x$:] Due to $\emptyset, x : () = \emptyset$, by rule (Ax) we have $\emptyset \vdash_k x: ()$.
    \item[Case $t = \lambda x.u$:] By the induction hypothesis we have $\emptyset \vdash_k u : ()$.
    Due to $\emptyset, x : () = \emptyset$ and $() \Rightarrow () = ()$, by rule ($\Rightarrow$I) we have $\emptyset \vdash_k \lambda x.u : ()$ .
    \item[Case $t = u\,v$:] By the induction hypothesis we have $\emptyset \vdash_k u : ()$ and $\emptyset \vdash_k v : ()$.
    For $R = \emptyset$ we have $() = R(()) \Rightarrow ()$ and $\emptyset \cup R(\emptyset) = \emptyset$.
    Therefore, by rule ($\Rightarrow$E) we have $\emptyset \vdash_k u\,v : ()$.\qedhere
\end{description}
\end{proof}


The following example demonstrates a type derivation in dimension $1$ for the term $\lambda x.x\,x$.
It also illustrates that the occurrence of sets of types in derivations does not necessarily increase dimension.

\begin{example}~\\
    We have $\emptyset \vdash_1 \lambda x.x\,x : (\{a, \{a\} \to b\} \to b)$ 
    by the following derivation, omitting rule (Ax) and using $R := \{(1, 1)\}$:\medskip\\
\AxiomC{$\{x : (\{\{a\} \to b\})\} \vdash_1 x : R((a)) \Rightarrow (b)$}
\AxiomC{$\{x : (\{a\})\} \vdash_1 x : (a)$}
\RightLabel{\textnormal{($\Rightarrow$E)}}
\BinaryInfC{$\{ x : (\{a, \{a\} \to b\})\} \vdash_1 x\,x : (b)$}
\RightLabel{\textnormal{($\Rightarrow$I)}}
\UnaryInfC{$\emptyset \vdash_1 \lambda x.x\,x : (\{a, \{a\} \to b\} \to b)$}
\DisplayProof

\end{example}

The following example illustrates the action of relations in order to introduce intersections.

\begin{example}~\\
For the following definitions 
\begin{itemize}
\item $\Gamma_1 := \{x : (\{\{b, c\} \to a\})\}$ 
\item $\Gamma_2 := \{y : (\{\{a\} \to b\}, \{\{a\} \to c\})\}$ 
\item $\Gamma_3 := \{x : (\{\{b, c\} \to a\}), y : (\{\{a\} \to b, \{a\} \to c\}), z : (\{a\})\}$
\item $R_1 := \{(1,1), (2,1)\}$
\item $R_2 := \{(1,1), (1,2)\}$
\end{itemize}
we have the following derivation:\medskip\\
\AxiomC{$\Gamma_1 \vdash_2 x : R_1((b, c)) \Rightarrow (a)$}
\AxiomC{$\Gamma_2 \cup R_2(\{z : (\{a\})\}) \vdash_2 y\,z : (b, c)$}
\RightLabel{\textnormal{($\Rightarrow$E)}}
\BinaryInfC{$\Gamma_3 \vdash_2 x\,(y\,z) : (a)$}
\DisplayProof\medskip\\
for which the judgment $\Gamma_2 \cup R_2(\{z : (\{a\})\}) \vdash_2 y\,z : (b, c)$ is derived in dimension $2$ as follows:\medskip\\
\AxiomC{$\Gamma_2 \vdash_2 y : R_2((a)) \Rightarrow (b, c)$}
\AxiomC{$\{z : (\{a\})\} \vdash_2 z : (a)$}
\RightLabel{\textnormal{($\Rightarrow$E)}}
\BinaryInfC{$\Gamma_2 \cup R_2(\{z : (\{a\})\}) \vdash_2 y\,z : (b, c)$}
\DisplayProof

\end{example}

The dimension bound limits the length of vectors occurring in a derivation, and therefore can be weakened to any larger bound.

\begin{lemma}[Dimensional Restriction]
Any vector occurring in a derivation of $\Gamma \vdash_k t : \bar{A}$ has at most $k$ coordinates.
\end{lemma}

\begin{proof}
    Induction on $t$.
\end{proof}

\begin{lemma}[Dimension Weakening]
    \label{lemma:dimension-weakening}
    If $\Gamma\vdash_k t : \bar{A}$ and $k \leq m$ then $\Gamma\vdash_m t:\bar{A}$.    
\end{lemma}
\begin{proof}
    Induction on $t$.
    For rule (Ax) the dimension restriction $n\leq k$ is replaced by $n\leq m$, which holds given $k \leq m$.
\end{proof}

Any type assumption can be weakened (increasing the cardinality of the corresponding assigned set of types) with no effect on dimension. 

\begin{lemma}[Weakening]
\label{lem:weak}
If $\Gamma \vdash_k t : \bar{A}$ and $\Gamma \subseteq \Delta$, then $\Delta \vdash_k t : \bar{A}$.
\end{lemma}

\begin{proof}
    Assuming $\Gamma \vdash_k t : \bar{A}$ and $\Gamma \subseteq \Delta$, we proceed by induction on $t$.
    \begin{description}
    \item[Case $t = x$:] Due to $\bar{A} \rbar{\in} \Gamma(x) \rbar{\subseteq} \Delta(x)$ we obtain the claim by rule (Ax).
    \item[Case $t = \lambda x.u$:] For some $\bar{\sigma}$ and $\bar{B}$ we have $\bar{A} = \bar{\sigma} \Rightarrow \bar{B}$, and by the induction hypothesis we have $\Delta, x : \bar{\sigma} \vdash_k u : \bar{B}$.
    By rule ($\Rightarrow$I) we obtain the claim.
    \item[Case $t = u\,v$:] For some $\Delta'$, $\Gamma'$, $\bar{B}$, and $R$ such that $\Gamma = \Gamma' \cup R(\Delta')$ we have $\Gamma' \vdash_k u : R(\bar{B}) \Rightarrow \bar{A}$ and $\Delta' \vdash_k v : \bar{B}$.
    Due to $\Gamma' \subseteq \Gamma \subseteq \Delta$ by the
    induction hypothesis we have $\Delta \vdash_k u : R(\bar{B}) \Rightarrow \bar{A}$.
    By rule ($\Rightarrow$E) we have $\Delta \cup R(\Delta') \vdash_k u\,v : \bar{A}$.
    Due to $R(\Delta') \subseteq \Gamma \subseteq \Delta$ we have 
    $\Delta \cup R(\Delta') = \Delta$, obtaining the claim.\qedhere
\end{description}
\end{proof}

A key technical insight for system \textbf{R} is the following Lemma~\ref{lem:transform}, which allows us to permute, remove, or copy vector coordinates in derivations.

\begin{lemma}
\label{lem:transform}
If $\Gamma \vdash_k t : \bar{A}$ and $R \subseteq \{1, \ldots, \dim(\bar{A})\} \times \{1, \ldots, m\}$ is right-unique and right-total, then $R(\Gamma) \vdash_{\max(k,m)} t : R(\bar{A})\!\!\downarrow$.
\end{lemma}

\begin{proof}
    Assuming $\Gamma \vdash_k t : \bar{A}$ and that $R$ is right-unique and right-total, we proceed by induction on $t$.
    Let $n=\max(k,m)$.
    \begin{description}
    %
    \item[Case $t = x$:] We have $\bar{A} \rbar{\in} \Gamma(x)$.
    By Lemma~\ref{lem:rel-properties}(\ref{prop:rel-properties:in}), we have $R(\bar{A})\!\!\downarrow\, \rbar{\in} R(\Gamma(x))$, which by rule (Ax) implies $R(\Gamma) \vdash_n x : R(\bar{A})\!\!\downarrow$.
    \item[Case $t = \lambda x.u$:] For some $\bar{\sigma}$ and $\bar{B}$ we have $\bar{A} = \bar{\sigma} \Rightarrow \bar{B}$, and by the induction hypothesis we have %
    %
    $R(\Gamma), x : R(\bar{\sigma}) \vdash_n u : R(\bar{B})\!\!\downarrow$.
    %
    By Lemma~\ref{lem:rel-properties}(\ref{prop:rel-properties:impl}) we have $R(\bar{\sigma}) \Rightarrow R(\bar{B})\!\!\downarrow\, = R(\bar{\sigma} \Rightarrow \bar{B})\!\!\downarrow\, = R(\bar{A})\!\!\downarrow$.
    By rule ($\Rightarrow$I) we obtain $R(\Gamma) \vdash_n \lambda x.u : R(\bar{A})\!\!\downarrow$.
    %
    \item[Case $t = u\,v$:] For some $\Delta$, $R'$, and $\bar{B}$ we have $\Delta \vdash_k v : \bar{B}$, and weakening the environment by Lemma~\ref{lem:weak}, we have $\Gamma \vdash_n u : R'(\bar{B}) \Rightarrow \bar{A}$.
    By the induction hypothesis we obtain $R(\Gamma) \vdash_n u : R(R'(\bar{B}) \Rightarrow \bar{A})\!\!\downarrow$.
    By Lemma~\ref{lemma:dimension-weakening} we have $\Delta \vdash_n v : \bar{B}$.
    Let $R'' = R \circ R'$.
    By Lemma~\ref{lem:rel-properties}(\ref{prop:rel-properties:impl}) we have $R(R'(\bar{B}) \Rightarrow \bar{A})\!\!\downarrow\, = R''(\bar{B}) \Rightarrow R(\bar{A})\!\!\downarrow$.
    By Lemma~\ref{lem:rel-properties}(\ref{prop:rel-properties:union}) we have $R(\Gamma) \cup R''(\Delta) = R(\Gamma \cup R'(\Delta))$.
    By rule ($\Rightarrow$E) we obtain $R(\Gamma \cup R'(\Delta)) \vdash_n u\,v : R(\bar{A})\!\!\downarrow$.\qedhere
\end{description}
\end{proof}

The following Example~\ref{xmp:deduplicate} illustrates use of the above Lemma~\ref{lem:transform} to permute, remove, or copy vector coordinates in derivations.

\begin{example}\label{xmp:deduplicate}
    Assume $\Gamma \vdash_k t : (A_1, A_2, A_3)$. By Lemma~\ref{lem:transform} we have:
    \begin{itemize}
        \item $R_1(\Gamma) \vdash_{\max(k, 2)} t : (A_3, A_1)$ where $R_1 := \{(1, 2), (3, 1)\}$
        \item $R_2(\Gamma) \vdash_{\max(k, 4)} t : (A_1, A_2, A_2, A_3)$ where $R_2 := \{(1, 1), (2, 2), (2, 3), (3, 4)\}$
    \end{itemize}
\end{example}

A subtle aspect of Lemma~\ref{lem:transform} is that coordinate copies do not increase the dimension besides the space required for their occurrence.

\begin{example}
    Let $\sigma := \{a,b,c\}$.
    We have $\{x : (\sigma), y : (\{\sigma \to d\})\} \vdash_3 y\,x : (d)$, and $3$ is the minimal dimension necessary to derive this judgment.
    By Lemma~\ref{lem:transform}, using the relation $\{(1,1), (1,2)\}$ we have $\{x : (\sigma, \sigma), y : (\{\sigma \to d\}, \{\sigma \to d\})\} \vdash_3 y\,x : (d, d)$, essentially copying the derivation.
    Still, dimension~$3$ suffices to account for the copied coordinate as seen in the following derivation obtained by the use of rule ($\Rightarrow$E)\medskip\\
    \AxiomC{$\{y : (\{\sigma \to d\}, \{\sigma \to d\})\} \vdash_3 y : R((a,b,c)) \Rightarrow (d, d)$}
    \AxiomC{$\{x : (\{a\},\{b\},\{c\})\} \vdash_3 x : (a,b,c)$}
    %\RightLabel{\textnormal{($\Rightarrow$E)}}
    \BinaryInfC{$\{x : (\sigma, \sigma), y : (\{\sigma \to d\}, \{\sigma \to d\})\} \vdash_3 y\,x : (d, d)$}
    \DisplayProof\medskip\\
    where $R := \{(1,1),(1,2),(2,1),(2,2),(3,1),(3,2)\}$ and $R((\{a\},\{b\},\{c\})) = (\sigma, \sigma)$.
\end{example}

The substitution lemma requires tight control over the way flows in the derivation of the term to be substituted fit variables of the term under substitution. This is managed by an appropriate relation $R$.

\begin{lemma}[Substitution Lemma]
    \label{lem:substitution-lemma}
    If $\Gamma, x : R(\bar{A}) \vdash_k t : \bar{B}$ and $\Delta \vdash_k u : \bar{A}$, then $\Gamma \cup R(\Delta) \vdash_k t[x := u] : \bar{B}$.
\end{lemma}

\begin{proof}
    Assuming $\Gamma, x : R(\bar{A}) \vdash_k t : \bar{B}$ and $\Delta \vdash_k u : \bar{A}$, we proceed by induction on $t$. We also note here that $\Gamma, x : R(\bar{A}) \vdash_k t : \bar{B}$ implies that
    $R\subseteq\{1,\ldots,\dim(\bar{A})\}\times\{1,\ldots,m\}$ where $m\leq k$.
    W.l.o.g.~$\bar{A}$ has distinct coordinates as we can remove duplicate ones by Lemma~\ref{lem:transform}.
    \begin{description}
    \item[Case $t = x$:] We have $\bar{B}_{[i]} \in R(\bar{A})_{[i]}$ for $i \in \{1, \ldots, \dim(\bar{B})\}$.
    Therefore, there is a right-unique $R' \subseteq R$ such that $R'(\bar{A}) = \bar{B}$.
    By Lemma \ref{lem:transform} we have $R'(\Delta) \vdash_k u : R'(\bar{A})\!\!\downarrow$.
    Due to $R' \subseteq R$, we obtain $\Gamma \cup R(\Delta) \vdash_k u : \bar{B}$
    by properties of vector transformations and the weakening lemma (cf.\ Lemma~\ref{lem:rel-properties}(\ref{prop:rel-properties:monotone}) and Lemma~\ref{lem:weak}).
    \item[Case $t = y \neq x$:] We have $\Gamma \vdash_k y : \bar{B}$ and the claim follows by the weakening lemma (cf. Lemma~\ref{lem:weak}).
    \item[Case $t = \lambda y.v$:] We may assume due to $\alpha$-conversion that $y \neq x$ and $y\not\in\var(u)$.  For some $\bar{\sigma}$ and $\bar{C}$ we have $\bar{B} = \bar{\sigma} \Rightarrow \bar{C}$ and %
    %
    $\Gamma, x : R(\bar{A}), y : \bar{\sigma} \vdash_k v : \bar{C}$.
    %
    By the induction hypothesis we obtain $\Gamma \cup R(\Delta), y : \bar{\sigma} \vdash_k v[x := u] : \bar{C}$.
    The claim follows by rule ($\Rightarrow$I).
    \item[Case $t = v\,w$:] For some $\Gamma'$, $\Delta'$, $R'$, $\bar{\sigma}$, $\bar{\tau}$, and $\bar{C}$ such that $\Gamma = \Gamma' \cup R'(\Delta')$ and $R(\bar{A}) = \bar{\tau} \rbar{\cup} R'(\bar{\sigma})$ we have $\Gamma', x : \bar{\tau} \vdash_k v : R'(\bar{C}) \Rightarrow \bar{B}$ and %
    $\Delta', x : \bar{\sigma} \vdash_k w : \bar{C}$.
    %
    Note that $R'\subseteq\{1,\ldots,\dim(\bar{C})\}\times\{1,\ldots,\dim(\bar{B})\}$. 
    W.l.o.g.~$R'$ is left-total. 
    %(NOTE: $R'$ should not be be left-unique - then the dimension may increase).
    In order to obtain the claim by rule ($\Rightarrow$E) we consider the corresponding premises.
    \begin{itemize}
        \item Due to $\bar{\tau} \rbar{\subseteq} R(\bar{A})$, by the weakening lemma 
        (cf.\ Lemma~\ref{lem:weak}) and the induction hypothesis we have $\Gamma' \cup R(\Delta) \vdash_k v[x := u] : R'(\bar{C}) \Rightarrow \bar{B}$.
        %
        \item Due to $R'(\bar{\sigma}) \rbar{\subseteq} R(\bar{A})$ and since $R'$ is left-total and $\bar{A}$ has distinct coordinates, by Lemma~\ref{lem:rel-properties}(\ref{prop:rel-properties:exact}) and Lemma~\ref{lem:rel-properties}(\ref{prop:rel-properties:compose}) there exists a $R''$ such that $R'\circ R''\subseteq R$ and $R''(\bar{A}) = \bar{\sigma}$.
        By the induction hypothesis we have $\Delta' \cup R''(\Delta) \vdash_k w[x := u] : \bar{C}$
    \end{itemize}
    By rule ($\Rightarrow$E) we have $\Gamma' \cup R(\Delta) \cup R'(\Delta' \cup R''(\Delta)) \vdash_k (v\,w)[x := u] : \bar{B}$.
    By the weakening lemma (cf. Lemma~\ref{lem:weak}), it suffices to show that $\Gamma' \cup R(\Delta) \cup R'(\Delta') \cup R'(R''(\Delta)) \subseteq \Gamma \cup R(\Delta)$.
    This follows from $\Gamma = \Gamma' \cup R'(\Delta')$ and $R' \circ R'' \subseteq R$. \qedhere
\end{description}
\end{proof}


\begin{lemma}[Subject Reduction]
    \label{lem:subject-reduction}
    If $\Gamma\vdash_k t : \bar{B}$ and $t\to_{\beta} u$ then $\Gamma\vdash_k u : \bar{B}$.
\end{lemma}
\begin{proof}
    The proof is by induction over $t$.
    \begin{description}
    \item[Case $t = x$:] This case is impossible since $x$ is in $\beta$-normal form.
    \item[Case $t = \lambda y.v$:] In this case, reduction has actually the form 
    $t=\lambda y.v\to_\beta \lambda y.v' = u$ where $v\to_\beta v'$. The only way to derive
    type for $\lambda y.v$ is to use rule ($\Rightarrow$I). This means that $\bar{B} = \bar{\sigma}\Rightarrow\bar{A}$ for some $\bar{\sigma}$ and $\bar{A}$. From that we get
    a derivation for $\Gamma, x:\bar{\sigma}\vdash_k v : \bar{A}$. We can now use the induction
    hypothesis to get $\Gamma, x:\bar{\sigma}\vdash_k v' : \bar{A}$ and then the rule ($\Rightarrow$I)
    to get  derivability of $\Gamma\vdash_k v' :\bar{\sigma}\Rightarrow\bar{A}$, which is the required conclusion.
    \item[Case $t = v\,w$:] In this case reduction has two forms. In the first of them, we reduce so that
    $v\,w\to_\beta v'\,w'$ where $v\to_\beta v'$ and $w=w'$ or $v=v'$ and $w\to_\beta w'$.
    To handle this situation, we can use
    decomposition by means of rule ($\Rightarrow$E) then the induction hypothesis and assemble the necessary derivation again by rule ($\Rightarrow$E).

    The second case is when $v=\lambda x.v'$ and reduction follows the $\beta$-redex 
    $(\lambda x.v')\,w \to_\beta v'[x:=w]$. Observe that the derivation of 
    $\Gamma\vdash_k (\lambda x.v')\,w : \bar{B}$ must end with rule ($\Rightarrow$E)
    \begin{displaymath}
        {\RightLabel{\textnormal{($\Rightarrow$E)}}
        \AxiomC{$\Gamma \vdash_{k} \lambda x.v' : R(\bar{A}) \Rightarrow \bar{B}$}
        \AxiomC{$\Delta \vdash_{k} w : \bar{A}$}
        \BinaryInfC{$\Gamma \cup R(\Delta) \vdash_k (\lambda x.v')\,w : \bar{B}$}
        \DisplayProof}
    \end{displaymath}
    for some relation $R$ and vector $\bar{A}$. Then rule ($\Rightarrow$I) must be used to derive
    $\Gamma \vdash_{k} \lambda x.v' : R(\bar{A}) \Rightarrow \bar{B}$, which gives derivation
    for $\Gamma, x:R(\bar{A}) \vdash_{k} v' :  \bar{B}$. We can now use the substitution lemma (cf.\ Lemma~\ref{lem:substitution-lemma}) to obtain $\Gamma \cup R(\Delta) \vdash_k v'[x:=w] : \bar{B}$,
    which is the desired conclusion.\qedhere
    \end{description}
\end{proof}

The present notion of dimension is neither invariant under $\beta$-expansion (Example~\ref{xmp:no-beta-expansion}), $\eta$-expansion (Example~\ref{xmp:no-eta-expansion}), nor under $\eta$-reduction (Example~\ref{xmp:no-eta-reduction}).

\begin{example}\label{xmp:no-beta-expansion}
    We have $\emptyset \vdash_1 (\lambda x.x)\,(\lambda x.x) : (\{a\} \to a)$ in bounded dimension $1$ and $(\lambda y.y\,y)\,(\lambda x.x) \to_\beta (\lambda x.x)\,(\lambda x.x)$.
    However, $\emptyset \vdash_k (\lambda y.y\,y)\,(\lambda x.x) : (\{a\} \to a)$ requires $k \geq 2$.
    This matches the understanding that typing a non-linear $\beta$-redex in an intersection type system may require intersection introduction.
\end{example}


%This is coherent with the understanding that typability of normal forms does not require intersection introduction (see principal schemes for normal forms~\cite[Definition~8]{cdv80}).

\begin{example}\label{xmp:no-eta-expansion}
    We have $\emptyset \vdash_1 \lambda x.x : (\{\{a, b\} \to c\} \to \{a, b\} \to c)$ in bounded dimension $1$ and $\lambda x y.x\,y \to_\eta \lambda x.x$.
    However, $\emptyset \vdash_k \lambda x y.x\,y : (\{\{a, b\} \to c\} \to \{a, b\} \to c)$ requires $k \geq 2$.
\end{example}

\begin{example}\label{xmp:no-eta-reduction}
    We have $\emptyset \vdash_1 \lambda x y.x\,y : (\{\{a\} \to c\} \to \{a, b\} \to c)$ and $\lambda x y.x\,y \to_\eta \lambda x.x$.
    However, $\emptyset \not\vdash_k \lambda x.x : (\{\{a\} \to c\} \to \{a, b\} \to c)$ for any dimension $k$.
\end{example}

The above Example~\ref{xmp:no-eta-expansion} and Example~\ref{xmp:no-eta-reduction} are coherent with intersection type systems which do not include subtyping and do require intersection introduction in order to assign an intersection of types (cf.\,Theorem~\ref{theorem:vanBakelS} and the line of work by van Bakel~\cite{Bakel04,Bakel11}).

\section{Relation to Traditional Intersection Type Systems}
\label{sec:iff_BCD}
As a technical tool to establish a relation with the traditional intersection type systems, we use the strict system of van Bakel \cite{Bakel04}, \cite[Section~5]{Bakel11}. This allows us to bring about a relation with the system of Barendregt, Coppo, Dezani-Ciancaglini \cite{BarendregtCD83}, which is expressed in Theorem~\ref{theorem:bcd}.


\begin{definition}[Strict Intersection Type System~{\cite[Definition~5.1]{Bakel11}}]
\label{def:strict-type-system}
~\\
The rules of the strict system are slightly adapted to notation used in this paper.

~

\begin{minipage}{\textwidth}
\centering
\begin{tabular}{l}
{\RightLabel{\textnormal{($\cap$E)}}
\AxiomC{$A \in \sigma$ }
\UnaryInfC{$\Sigma, x : \sigma \vdash_S x : A$}
\DisplayProof}\quad
{\RightLabel{\textnormal{($\cap$I)}}
\AxiomC{$\Sigma\vdash_S t : A_1, \ldots, \Sigma\vdash_S t : A_n$}
\UnaryInfC{$\Sigma\vdash_S t : \{A_1,\ldots,A_n\}$}
\DisplayProof}
\\\\
{\RightLabel{\textnormal{($\to$I)}}
\AxiomC{$\Sigma, x: \sigma \vdash_S t : A$}
\UnaryInfC{$\Sigma \vdash_S \lambda x.t : \sigma \to A$}
\DisplayProof}\quad
{\RightLabel{\textnormal{($\to$E)}}
\AxiomC{$\Sigma \vdash_S t : \sigma \to B$}
\AxiomC{$\Sigma \vdash_S u : \sigma$}
\BinaryInfC{$\Sigma \vdash_S t\, u : B$}
\DisplayProof}
\end{tabular}
\end{minipage}
\end{definition}

\begin{lemma}
    \label{lemma:fromvanBakel}
    %Assume that $\Sigma_i = \{ x_1:\sigma^1_i,\ldots, x_m:\sigma^m_i\}$ for $i\in\{1,\ldots, n\}$ as %well as $\bar\sigma^j = (\sigma^j_1,\ldots,\sigma^j_n)$ and $\bar{A} = (A_1,\ldots, A_n)$. 

    If $\Gamma_{[i]}\vdash_S t:\bar{A}_{[i]}$ for each $i\in\{1,\ldots, \dim(\bar{A})\}$ then $\Gamma\vdash t:\bar{A}$.
\end{lemma}
\begin{proof}
    Induction on $t$. Let $n := \dim(\bar{A})$ and assume $\Gamma_{[i]}\vdash_S t:\bar{A}_{[i]}$ for each $i\in\{1,\ldots, n\}$.

     \begin{description}
        %
        \item[Case $t=x$.] If $\Gamma_{[i]}\vdash_S x:\bar{A}_{[i]}$ for $i\in\{1,\ldots, n\}$ then each $\Gamma_{[i]}$ contains declaration $x:\bar{\sigma}_{[i]}$ such that $\bar{A}_{[i]}\in\bar{\sigma}_{[i]}$. 
        Consequently, $\bar{A}\rbar{\in}\bar{\sigma}$ and we can use the (Ax) rule to get $\Gamma\vdash t:\bar{A}$.
        %
        \item[Case $t=\lambda x.u$.] If $\Gamma_{[i]}\vdash_S \lambda x.u:\bar{A}_{[i]}$ for $i\in\{1,\ldots,n\}$, then these judgments must be the result of ($\to$I) rule. Consequently, $\bar{A} = \bar{\sigma}\Rightarrow \bar{B}$ for some $\bar{\sigma}$ and $\bar{B}$ and we have derivations for $\Gamma_{[i]},x:\bar{\sigma}_{[i]}\vdash_S u:\bar{B}_{[i]}$. By the induction hypothesis, we obtain that $\Gamma, x:\bar{\sigma}\vdash u:\bar{B}$. We can now apply the ($\Rightarrow$I) rule and obtain $\Gamma\vdash \lambda x.u:\bar{A}$.
        %
        \item[Case $t=u\; v$.] If  $\Gamma_{[i]}\vdash_S u\, v:\bar{A}_{[i]}$ then this can only be derived by ($\to$E) rule. Consequently, we have derivations for 
        $\Gamma_{[i]}\vdash_S u : \bar{\sigma}_{[i]}\to \bar{A}_{[i]}$ and $\Gamma_{[i]}\vdash_S v:\bar{\sigma}_{[i]}$ for some $\bar{\sigma}$.
        Then the only way to derive $\Gamma_{[i]}\vdash_S v:\bar{\sigma}_{[i]}$ is to use ($\cap$I) rule so that $\Gamma_{[i]}\vdash_S v:B^j_i$ where for some $k_i$  we have $\bar{\sigma}_{[i]} = \{ B^1_i,\ldots,B^{k_i}_i\}$. 
        Assume $\Gamma = \{ x_1 :\bar{\sigma}^1,\ldots,x_m:\bar{\sigma}^m\}$. 
        By the induction hypothesis we construct a derivation for 
        $\Delta\vdash v:\bar{B}$ where 
        \begin{displaymath}
            \begin{array}{l}
                \Delta := \{ x_1: \bar\tau^1,\ldots,x_m:\bar\tau^m\}\\
                %
                \bar\tau^i := (\underbrace{\bar{\sigma}^i_{[1]},\ldots\bar{\sigma}^i_{[1]}}_{k_1 \mbox{\small times}},
                              \ldots, %
                              \underbrace{\bar{\sigma}^i_{[n]},\ldots\bar{\sigma}^{i}_{[n]}}_{k_n \mbox{\small times}}
                ) \quad \mbox{ for } i\in\{1,\ldots,m\}\\
                % 
                \bar{B} := (B^1_1,\ldots,B^{k_1}_1, %
                 \ldots, %
                 B^1_n,\ldots,B^{k_n}_n)
            \end{array}
        \end{displaymath}
        Let $l_0 := 0$ and $l_i := \sum_{j=1}^{i}k_j$ for $i\in\{1,\ldots,n\}$. We define the relation 
        %
        $R := \{ (p,q) \mid q\in\{1,\ldots,n\} \mbox{ and } l_{q-1} < p \leq l_q\}$.
        %
        Observe that 
        \begin{equation}
        \label{eq:bartimes}
            \begin{array}{l}
                 R(\bar{B})_{[j]} = \bar{\sigma}_{[j]} \quad\mbox{and}\quad
                 %
                R(\Delta(x_i)) = \bar{\sigma}^i\\
            \end{array}
        \end{equation}
        for $j\in\{1,\ldots,n\}$ and $i\in\{1,\ldots,m\}$.
        Note that $R(\Delta) = \Gamma$ and $R(\bar{B}) = \bar{\sigma}$ by observation~(\ref{eq:bartimes}) above.
        From the induction hypothesis we get $\Gamma\vdash u:\bar\sigma\Rightarrow\bar{A}$,
        and we can apply rule ($\Rightarrow$E) to obtain $\Gamma\vdash u\, v:\bar{A}$.\qedhere
     \end{description}
\end{proof}

\begin{lemma}
    \label{lemma:toS}
    If $\Gamma\vdash t:\bar{A}$ then 
    for each $i\in\{1,\ldots,\dim(\bar{A})\}$ we have
    $\Gamma_{[i]}\vdash_S t:\bar{A}_{[i]}$.
\end{lemma}
\begin{proof}
    Induction on $t$. Let $n := \dim(\bar{A})$ and assume $\Gamma\vdash t:\bar{A}$.
    \begin{description}
        \item[Case $t=x$.] If $\Gamma\vdash x:\bar{A}$ then it can be derived only by the (Ax) rule. Consequently, there is $(x:\bar{\sigma}) \in\Gamma$ such that $\bar{A} \rbar{\in} \bar{\sigma}$. Consequently, we can use ($\cap$E) rule to obtain $\Gamma_{[i]}\vdash_S x:\bar{A}_{[i]}$ for $i\in\{1,\ldots, n\}$.
        %
        \item[Case $t=\lambda x.u$.] The judgment $\Gamma\vdash \lambda x.u:\bar{A}$ can be derived only by the ($\Rightarrow$I) rule and thus $\bar{A}=\bar{\sigma}\Rightarrow\bar{B}$ for some $\bar{\sigma}$ and $\bar{B}$ and also $\Gamma,x:\bar{\sigma}\vdash u:\bar{B}$
        is derivable. By the induction hypothesis, we obtain $\Gamma_{[i]},x:\bar{\sigma}_{[i]}\vdash_S u:\bar{B}_{[i]}$ for each $i\in\{1,\ldots, n\}$. Then rule ($\to$I) gives
        us derivability of $\Gamma_{[i]}\vdash_S \lambda x.u:\bar{\sigma}_{[i]}\to\bar{B}_{[i]}$. As 
        $\bar{\sigma}_{[i]}\to\bar{B}_{[i]} =\bar{A}_{[i]}$ we obtain the claim.
        %
        \item[Case $t=u\; v$.] The judgment $\Gamma\vdash u\, v:\bar{A}$ can be derived only by ($\Rightarrow$E) rule. Consequently, $\Gamma = \Gamma'\cup R(\Delta)$ for some $\Gamma', \Delta$, and $R$ such that
        $R(\bar{B})_{[i]} = \bar{\sigma}_{[i]}$ for $i\in\{1,\ldots,n\}$, and
        %
        $\Gamma'\vdash u:\bar{\sigma}\Rightarrow\bar{A}$ and 
        %
        $\Delta\vdash v:\bar{B}$ 
        %
        are derivable. By the induction hypothesis, we can derive
        \begin{equation}
        \label{eq:bardownstairs}
            \begin{array}{ll}
                 \Gamma'_{[i]}\vdash_S u:\bar{\sigma}_{[i]}\to\bar{A}_{[i]} 
                 & \mbox{ for } i\in\{1,\ldots,n\}\\
                 \Delta_{[j]}\vdash_S v:\bar{B}_{[j]} 
                 & \mbox{ for } j\in\{1,\ldots,\dim(\bar{B})\}
            \end{array}
        \end{equation}
        We have $\Gamma'(x) \rbar{\cup} R(\Delta)(x)\rbar{\subseteq} \Gamma(x)$
        for $x\in\dom(\Gamma)$, and therefore
        %and consequently $(R(\Delta)(x))_{[i]}\subseteq(\Gamma(x))_{[i]}$
        $(\Delta(x))_{[j]}\subseteq(\Gamma(x))_{[i]}$ for $(j, i) \in R$.
        We can now apply the weakening lemma to derivations in (\ref{eq:bardownstairs})
        and obtain %
        %
        $\Gamma_{[i]}\vdash_S v:\bar{B}_{[j]}$ for $(j, i) \in R$, as well as
        %
        $\Gamma_{[i]}\vdash_S u:\bar\sigma_{[i]}\to\bar{A}_{[i]}$ for $i\in\{1,\ldots,n\}$.
        %
         Using rule ($\cap$I) we derive 
         %
         $\Gamma_{[i]}\vdash_S v:\{ \bar{B}_{[j]} \mid j\,R\,i\}$.
         %
         Application of the ($\to$E) rule gives $\Gamma_{[i]}\vdash_S u\, v:\bar{A}_{[i]}$ for $i\in\{1,\ldots,n\}$. \qedhere
    \end{description}
\end{proof}

An important consequence of the lemma above is that many properties of the van Bakel's system are inherited. In particular, the system of the current paper has the strong normalization property as van Bakel's system has \cite[Theorem~7.5]{Bakel04}.

As a final step, we establish the connection with the system BCD of Barendregt, Coppo, Dezani-Ciancaglini \cite{BarendregtCD83}.
The set of types in this system is bigger than the set of strict types of van Bakel.
However, for each type $\varphi$ in this system there are strict types $A_1,\ldots,A_n$ such that $\varphi$ is
equivalent to $\{A_1,\ldots,A_n\}$ (cf.\ \cite[Lemma 2.2.2]{Bakel92}).
This equivalence is the canonical equivalence induced by the quasi-order $\leq$ that is the subtyping relation in BCD system.
Therefore, we do not lose any generality by writing $\Sigma\vdash_{\textnormal{BCD}} t:\sigma$, where $\Sigma$ and $\sigma$ comply to the syntax used in this paper.
We can also write $\Sigma\vdash_{\textnormal{BCD}} t:A$ as strict types are a special case of BCD types.
%
%We can embed the intersection types from Definition~\ref{def:itypes} using the following
%translation:
%\begin{itemize}
%    \item $a^\triangleleft = a$
%    \item $(\sigma\to A)^\triangleleft = \sigma^\triangleleft\to A^\triangleleft$
%    \item $\emptyset^\triangleleft = \omega$
%    \item $\{A_1,\ldots,A_n\}^\triangleleft = 
%        A_1^\triangleleft\land\cdots\land A_n^\triangleleft$. 
%\end{itemize}
%The translation naturally extends to environments by application of the transformation above to types.
%
%The formulation of the theorem that relates the strict system with the system of BCD
%uses the standard semantical ordering $\leq$ on types. We recall it here for completeness. We say that $\varphi\leq\psi$ when the relation can be established by means of the following axioms:
%\begin{itemize}
%    \item $\varphi\leq\varphi$,
%    \item $\varphi\leq\omega$ 
%    \item $\omega\leq\omega\to\omega$ 
%    \item $\varphi\land\psi\leq\varphi$
%    \item $\varphi\land\psi\leq\psi$
%    \item $(\varphi\to\psi)\land(\varphi\to\psi')\leq \varphi\to(\psi\land\psi')$
%    \item $\varphi\leq\varphi'\leq\varphi'' \Rightarrow \varphi\leq\varphi''$
%    \item $\varphi\leq\psi$ and $\varphi\leq\psi' \Rightarrow \varphi\leq(\psi\land\psi')$
%    \item $\varphi'\leq\varphi$ and $\psi\leq\psi' \Rightarrow \varphi\to\psi\leq\varphi'\to\psi'$
%\end{itemize}
 To establish the relation between our system and the system BCD, we use the following statement mentioned in \cite[Section~5]{Bakel11}. 
\begin{theorem}[van Bakel, \cite{Bakel11}]
    \label{theorem:vanBakelS}
    If $\Sigma\vdash_{\textnormal{BCD}} t:\sigma$ then there are $\Sigma', A_1,\ldots,A_n$ such that $\Sigma\leq\Sigma'$, $\Sigma' \vdash_{S} t:A_i$ for each $i\in\{1,\ldots,n\}$ and $\{A_1,\ldots,A_n\}\leq\sigma$.

    Moreover, If $\Sigma \vdash_{S} t:A$ then $\Sigma\vdash_{\textnormal{BCD}} t:A$.
\end{theorem}
A similar theorem was proved in \cite{Bakel92}  (Theorem 2.2.6) for another variant of the strict system the rules of which are derivable in the strict system of van Bakel used in this paper.

Note that the formulation above omits the condition that $t$ is in $\lambda\bot$-normal form, which is present in \cite{Bakel92}.
This condition is trivially fulfilled as our terms do not use the constant $\bot$.
In addition, the original formulation in \cite{Bakel92} does not include the second part, which obtains a~derivation in BCD from the one in the strict system.
However, this part easily follows by observation that the rules of the strict system in its presentation in \cite{Bakel11} are derivable in BCD system.
We need one more result concerning the type ordering.
\begin{proposition}
    \label{prop:picking}
    If $\sigma\leq\sigma'$ then
    there is $\tau\subseteq\sigma$ such that $|\tau|\leq  |\sigma'|$ and $\tau\leq\sigma'$.
\end{proposition}
\begin{proof}
    For the proof we use an observation made by Hindley, cf. \cite[Lemma~3(i)]{Hindley82}, which also follows by easy induction from the work of Barendregt, Coppo, Dezani-Ciancaglini \cite[Lemma 2.4(ii)]{BarendregtCD83}:
    \emph{If $\{A_1,\ldots,A_n\}\leq \{B_1,\ldots,B_m\}$ then for each $i\in\{1,\ldots,m\}$ there is $j\in\{1,\ldots,n\}$ such that $A_j\leq B_i$.}
    
    To prove the current proposition we observe that $\sigma$ can be presented as $\{A_1,\ldots,A_n\}$ and $\sigma'$ as $\{B_1,\ldots,B_m\}$.
    By the observation above, we take for each $i\in\{1,\ldots,m\}$ only one $A_{j_i}$ such that $A_{j_i}\leq B_i$.
    We obtain then immediately that $\{A_{j_1},\ldots,A_{j_m}\}\leq\sigma'$.
\end{proof}

The considerations above give us the following comparison of derivability in our system and the system BCD.
\begin{theorem} ~
    \label{theorem:bcd}
    \begin{enumerate}
        \item If $\Gamma \vdash_k t : \bar{A}$ then for $i\in\{1,\ldots,\dim(\bar{A})\}$
             we have $\Gamma_{[i]}\vdash_{\textnormal{BCD}} t : \bar{A}_{[i]}$.

        \item If $\Sigma \vdash_{\textnormal{BCD}} t : \sigma$ where $\sigma = \{A_1,\ldots, A_n\}$
            then there are $\Gamma,\bar{B}$ with $\dim(\Gamma)=\dim(\bar{B})=n$
            such that $\Sigma \leq\Gamma_{[i]}$, $\Gamma \vdash_k t : \bar{B}$ for some $k$ and
                $\{\bar{B}_{[1]},\ldots,\bar{B}_{[n]}\}\leq \sigma$.
    \end{enumerate}
\end{theorem}
\begin{proof}
    For the proof of (1), we assume $\Gamma \vdash_k t : \bar{A}$, which by Lemma~\ref{lemma:toS} gives us that $\Gamma_{[i]}\vdash_S t : \bar{A}_{[i]}$ for $i\in\{1,\ldots,\dim(\bar{A})\}$.
    Then the second statement of Theorem~\ref{theorem:vanBakelS} gives us that $\Gamma_{[i]}\vdash_{\textnormal{BCD}} t:\bar{A}_{[i]}$.

    For the proof of (2), we assume that $\Sigma \vdash_{\textnormal{BCD}} t : \sigma$. By the first statement of Theorem~\ref{theorem:vanBakelS}, we obtain an environment $\Sigma'$ such that $\Sigma\leq\Sigma'$ and a type $\sigma' = \{B_1,\ldots, B_{m}\}$ such that
    $\Sigma' \vdash_S t : B_i$ for all $i\in\{1,\ldots,m\}$ and %
    $\{B_1,\ldots, B_{m}\}\leq \sigma$ for some $m$ (*). 
    Note that we may assume that $m=n$.
    Indeed, when $n<m$ we just introduce more copies of some coordinate $i$, cf.\ Lemma~\ref{lem:transform}.
    When $m<n$, we use Proposition~\ref{prop:picking} to obtain some $\tau\subseteq\sigma$ the size of which
    is not greater than the size of $\sigma'$ and by the inclusion $\tau\subseteq\sigma$ we still
    have $\Sigma' \vdash_S t : B$  for all $B\in\tau$.
    %
    This means that $\Sigma \vdash_{S} t : B_i$ for each  $i\in\{1,\ldots,n\}$.
    Consider now $\bar{B} = (B_1,\ldots,B_n)$. 
    We now define a context $\Gamma$ so that $\dom(\Gamma)=\dom(\Sigma)$ and $(x:\bar{\rho}_x)\in\Gamma$ for
    $\bar{\rho}_x = (\underbrace{\rho,\ldots,\rho}_{n\mbox{\scriptsize -times}})$
    where $(x:\rho)\in\Sigma$. Note that $\Gamma_{[i]} = \Sigma$ so Lemma~\ref{lemma:fromvanBakel} gives us that  $\Gamma\vdash_k t:\bar{B}$ for some $k$. 
    Note that $\{\bar{B}_{[1]},\ldots,\bar{B}_{[n]}\}\leq\sigma$ by (*).
\end{proof}

\section{Decidability of Inhabitation in Bounded Dimension}
\label{sec:inh_dec}
In this section, we give the main result of the present work: inhabitation in bounded dimension is decidable in \textsf{2-EXPTIME}.
This result is supplemented by the observation that for each fixed dimension inhabitation is decidable in \textsf{EXPTIME}.

\begin{definition}[Inhabitation in Bounded Dimension]
    Given $\Gamma$, $\bar{A}$, and $k$ is the judgment $\Gamma \vdash_k t : \bar{A}$ derivable for some term $t$?
\end{definition}

The proof of decidability is constructed in three steps.
First, we establish inversion properties (Lemma~\ref{lem:lam_inversion} and Lemma~\ref{lem:apps_inversion}) for abstraction and iterated application.
Second, we formulate a subformula property (Lemma~\ref{lemma:subformula}) for $\beta$-normal form derivations to restrict the inhabitant search space.
Third, we give an alternating exponential space inhabitant search algorithm, obtaining a \textsf{2-EXPTIME} upper bound on inhabitation (Theorem~\ref{thm:upper_complexity_bound}).

\begin{lemma}\label{lem:lam_inversion}
    If $\Gamma \vdash_k \lambda x.t : \bar{B}$, then $\bar{B} = \bar{\sigma} \Rightarrow \bar{A}$ for some $\bar{\sigma}$ and $\bar{A}$, and $\Gamma, x : \bar{\sigma} \vdash_k t : \bar{A}$.
\end{lemma}

\begin{proof}
    Case analysis regarding the last rule application.
\end{proof}

\begin{lemma}\label{lem:apps_inversion}
    If $\Gamma \vdash_k x\,u_1 \ldots u_n : \bar{B}$ then there exists $\bar{A}_1, \ldots, \bar{A}_n, R_1, \ldots, R_n, \Delta_1, \ldots, \Delta_n$ such that
    \begin{enumerate}
        \item\label{prop:apps_inversion:dims} $R_i \subseteq \{1, \ldots, \dim(\bar{A}_i)\} \times \{1, \ldots, k\}$ is left-total and $\dim(\bar{A}_i) \leq k$ for $i \in \{1, \ldots, n\}$
        \item\label{prop:apps_inversion:type} $R_1(\bar{A}_1) \Rightarrow \cdots \Rightarrow R_n(\bar{A}_n) \Rightarrow \bar{B} \rbar{\in} \Gamma(x)$
        \item\label{prop:apps_inversion:subset} $R_i(\Delta_i) \subseteq \Gamma$ for $i \in \{1, \ldots, n\}$
        \item\label{prop:apps_inversion:Delta} $\Delta_i \vdash_k u_i : \bar{A}_i$ for $i \in \{1, \ldots, n\}$
        \item\label{prop:apps_inversion:partial_type} $\Gamma \vdash_k x\,u_1\ldots u_i : R_{i+1}(\bar{A}_{i+1}) \Rightarrow \cdots \Rightarrow R_n(\bar{A}_n) \Rightarrow \bar{B}$ for $i \in \{1, \ldots, n\}$
    \end{enumerate}
\end{lemma}

\begin{proof}
    Induction on $n$ and case analysis regarding the last rule application.
    Left-totality of relations $R_1, \ldots, R_n$ for Property~(\ref{prop:apps_inversion:dims}) is established using Lemma~\ref{lem:transform}.
    Property~(\ref{prop:apps_inversion:partial_type}) is established using Lemma~\ref{lem:weak}.
\end{proof}

With each type or a set of types we associate a set of subformulae (types or sets of types), by the following Definition~\ref{def:subformula}.

\begin{definition}[Subformula]\label{def:subformula}~
\begin{itemize}
    \item $\form(a) := \{a\}$
    \item $\form(\sigma \to A) := \{\sigma \to A\} \cup \form(\sigma) \cup \form(A)$
    \item $\form(\sigma) := \{\sigma\} \cup \bigcup_{A \in \sigma} \form(A)$
\end{itemize}
The notion of occurring subformulae is extended to vectors:
\begin{itemize}
    \item $\form(\bar{A}) := \bigcup_{i=1}^{\dim(\bar{A})} \form(\bar{A}_{[i]})$ and $\form(\bar{\sigma}) := \bigcup_{i=1}^{\dim(\bar{\sigma})} \form(\bar{\sigma}_{[i]})$
\end{itemize}
\end{definition}

The number of subformulae of a given type or set of types is polynomial in the number of nodes in its syntax tree, illustrated by the following example.

\begin{example}\label{xmp:subformula_no_blowup}
    We have $\form(\{a, b\} \to c) = \{\{a, b\} \to c, \{a, b\}, a, b, c\}$.
    In particular, the set $\{a, b\}$ and the types $a, b$ are subformulae of $\{a, b\} \to c$, but the sets $\{a\}$ and $\{b\}$ are not.
\end{example}

\begin{lemma}[Subformula Property]
    \label{lemma:subformula}
    Assume that $\Gamma\vdash_k t : \bar{A}$ such that $t$ is in $\beta$-normal form.
    Let $\mathcal{F} := \form(\bar{A}) \cup \bigcup \{\form(\bar{\tau}) \mid (y : \bar{\tau}) \in \Gamma\}$ be the set of all subformulae of types and sets of types occurring in $\Gamma$ and $\bar{A}$.
    There is a derivation of $\Gamma\vdash_k t : \bar{A}$
    such that for each judgment $\Delta\vdash_k u : \bar{B}$ in this derivation we have
    \begin{enumerate}
        \item\label{lemma:subformula:env} for $(x:\bar{\sigma})\in\Delta$ and $i\in\{1,\ldots,\dim(\Delta)\}$ we have $\bar{\sigma}_{[i]} \in \mathcal{F} \cup \{\emptyset\}$
        \item\label{lemma:subformula:typ} $\bar{B}_{[i]} \in \mathcal{F}$ for $i\in\{1,\ldots,\dim(\bar{B})\}$
    \end{enumerate}
\end{lemma}

\begin{proof}
    Induction on the size of $t$. There are two cases.
    \begin{description}
        \item[Case $t = \lambda x.u$:] Follows immediately from Lemma~\ref{lem:lam_inversion} and the induction hypothesis.
        \item[Case $t = x\,u_1 \ldots u_n$:] There exist $\bar{A}_1, \ldots, \bar{A}_n$, $R_1, \ldots, R_n$, $\Delta_1, \ldots, \Delta_n$ satisfying properties of Lemma~\ref{lem:apps_inversion}(\ref{prop:apps_inversion:dims}) -- Lemma~\ref{lem:apps_inversion}(\ref{prop:apps_inversion:partial_type}).
        Judgments $\Gamma \vdash_k x\,u_1\ldots u_i : R_{i+1}(\bar{A}_{i+1}) \Rightarrow \cdots \Rightarrow R_n(\bar{A}_n) \Rightarrow \bar{B}$ (cf.\,Lemma~\ref{lem:apps_inversion}(\ref{prop:apps_inversion:partial_type})) satisfy properties (\ref{lemma:subformula:env}) and (\ref{lemma:subformula:typ}).
        While subderivations $\Delta_i \vdash_k u_i : \bar{A}_i$ for $i \in \{1, \ldots, n\}$ satisfy Property~(\ref{lemma:subformula:typ}), they do not necessarily satisfy Property~(\ref{lemma:subformula:env}).
        By Lemma~\ref{lem:apps_inversion}(\ref{prop:apps_inversion:subset}) type assumptions in $\Delta_i$ for $i \in \{1, \ldots, n\}$ may be strict subsets of subformulae in $\mathcal{F}$.
        By Lemma~\ref{lem:weak} and Lemma~\ref{lem:rel-properties}(\ref{prop:rel-properties:saturate}) we can weaken the type assumptions by saturating the sets of types to subformulae in $\mathcal{F}$.
        This results in derivation environments $\Delta_1', \ldots, \Delta_n'$ and subderivations of judgments $\Delta_i' \vdash_k u_i : \bar{A}_i$ for $i \in \{1, \ldots, n\}$ satisfying properties (\ref{lemma:subformula:env}) and (\ref{lemma:subformula:typ}).
        We obtain the claim by the induction hypothesis and repearted application of rule ($\Rightarrow$E).\qedhere
    \end{description}
\end{proof}



\begin{theorem}\label{thm:upper_complexity_bound}
Given $\Gamma$, $\bar{A}$, and $k$ it is decidable in \textsf{2-EXPTIME} whether the judgment $\Gamma \vdash_k t : \bar{A}$ is derivable for some term $t$.
\end{theorem}

\begin{proof}
In order to decide whether $\Gamma \vdash_k t : \bar{A}$ is derivable for some $t$, by subject reduction (Lemma~\ref{lem:subject-reduction}) and strong normalization properties~\cite[Theorem~7.5]{Bakel04} (combined with Lemma~\ref{lemma:toS}) it suffices to consider $t$ in $\beta$-normal form.
We develop an \textsf{AEXPSPACE} decision procedure.

Let $\mathcal{F} := \form(\bar{A}) \cup \bigcup \{\form(\bar{\tau}) \mid (y : \bar{\tau}) \in \Gamma\}$ be the set of all subformulae of types and sets of types occurring in $\Gamma$ and $\bar{A}$, and let $N := |\mathcal{F}|$ denote its cardinality.
By Lemma~\ref{lemma:subformula}, we can consider a derivation of $\Gamma \vdash_k t : \bar{A}$ such that for each judgment $\Delta \vdash_k u : \bar{B}$ in this derivation each coordinate of occurring type vectors can take at most $N + 1$ distinct values (including the empty set for sets of types in environments).
Therefore, the number of distinct $k$-dimensional vectors to consider in derivations is bounded by $(N+1)^k$.

The decision procedure works as follows.
First, we non-deterministically guess whether $t$ is of shape $\lambda x.u$ for some $x$ and $u$, or of shape $x\,u_1 \ldots u_n$ for some $x \in \dom(\Gamma)$ and some $u_1, \ldots, u_n$ where $n$ is bounded by the maximal nesting of the arrow type constructor to the right in types occurring in $\Gamma(x)$.

If $t$ is of shape $\lambda x.u$, then by Lemma~\ref{lem:lam_inversion} we have $\bar{A} = \bar{\sigma} \Rightarrow \bar{A'}$ for some $\bar{\sigma}$ and $\bar{A'}$, and we recursively decide whether $\Gamma, x : \bar{\sigma} \vdash_k u : \bar{A'}$ holds for some $u$.

If $t$ is of shape $x\,u_1 \ldots u_n$, then we use Lemma~\ref{lem:apps_inversion}, universally branching in $i \in \{1, \ldots, n\}$.
In each branch $i$, we non-deterministically guess the necessary relation $R_i$ (bounded in cardinality by $k^2$), type vector $\bar{A}_i$, environment $\Delta_i$, and recursively decide whether $\Delta_i \vdash_k u_i : \bar{A}_i$ is derivable for some $u_i$.

By the pigeonhole principle, if a type environment contains more than $(N+1)^k$ variables, some must have identical assigned vectors.
In the non-deterministic guess of the shape $\lambda x.u$, if $x$ is assigned the vector $\Gamma(y)$ for some $y \in \dom(\Gamma)$, we can equivalently guess $\lambda x.u[x := y]$ instead and remove the assumption on $x$.

Overall, the space required by the alternating decision procedure is polynomial in $(N+1)^k$, yielding an \textsf{AEXPSPACE}, or equivalently, a \textsf{2-EXPTIME} decision procedure.
\end{proof}

If we fix a dimension $k$, we obtain an \textsf{EXPTIME} inhabitation decision procedure.
To avoid an exponential blowup, it is essential for the subformula property to not include strict subsets of sets of types occurring in the input (cf.~Example~\ref{xmp:subformula_no_blowup}).

\begin{theorem}\label{thm:upper_complexity_bound_fixed}
    For any $k \in \mathbb{N}$, given $\Gamma$ and $\bar{A}$ it is decidable in \textsf{EXPTIME} whether the judgment $\Gamma \vdash_k t : \bar{A}$ is derivable for some term $t$.
\end{theorem}

\begin{proof}
    Similarly to the proof of Theorem~\ref{thm:upper_complexity_bound}, the number of distinct vectors in recursive invocation of the decision procedure is $(N+1)^k$, which is polynomial for any fixed $k$.
    This yields an \textsf{APSPACE}, or equivalently, an \textsf{EXPTIME} decision procedure.
\end{proof}

\section{Comparison with the Multiset-dimensional System}
\label{sec:mset_dim}
Comparing the presented dimensionally bounded system to the currently most expressive dimensionally bounded system $(\Vdash_k)$ with decidable inhabitation~\cite[Section~3.2]{DudenhefnerR17}, one can observe several differences.

The system $(\Vdash_k)$ introduces non-idempotent intersection types\footnote{Differently from traditional literature~\cite{BucciarelliKV17}, non-idempotence captures intersection introduction as a resource.} (multisets to the left of the arrow) as annotations throughout the derivation.
This induces additional bookkeeping (see side condition $(\star)$~\cite[Section~3.2]{DudenhefnerR17} in rule $(\cap\textnormal{I})$), and the  correspondence to established intersection type systems (both idempotent and non-idempotent) is not immediate.

The most important difference is that the individual dimensions in system $(\Vdash_k)$ are strictly less comprehensive wrt. inhabited terms.
First, any derivation in $(\Vdash_k)$ can be translated to a derivation in $(\vdash_k)$.

\begin{lemma}\label{lem:multiset_to_vector}
    If $\Gamma_{[1]} \Vdash_k t : A$, then $\Gamma \vdash_k t : (A)$.
\end{lemma}

\begin{proof}
    Both ($\Vdash_k$) and ($\vdash_k$) follow derivations ($\vdash_S$).
    Using lexicographic ordering, multisets of cardinality at most $k$ at top-level can be captured by vectors of size at most $k$.
    Therefore, the same construction as the proof of Lemma~\ref{lemma:fromvanBakel} applies for the translation.    
\end{proof}

Since inhabitation in $(\Vdash_k)$ is \textsf{EXPSPACE}-complete~\cite[Theorem~34]{DudenhefnerR17}, the above Lemma~\ref{lem:multiset_to_vector} implies \textsf{EXPSPACE}-hardness of inhabitation in $(\vdash_k)$.

\begin{corollary}\label{cor:inh_lower_bound}
    Given $\Gamma$, $\bar{A}$, and $k$ it is \textsf{EXPSPACE}-hard to decide whether the judgment $\Gamma \vdash_k t : \bar{A}$ is derivable for some term $t$.
\end{corollary}

Second, the following Lemma~\ref{lem:exp_blowup_1} shows that there are types $A_1, A_2, \ldots$ which are inhabited in dimension $2$, but each $A_i$ requires multiset dimension $2^i$ to be assigned to any term. 

\begin{lemma}\label{lem:exp_blowup_1}
    There exists a family of types $\{A_1, A_2, \ldots\}$ such that for all $n \in \mathbb{N}$:
    \begin{enumerate}
        \item The size (number of nodes in the syntax tree) of $A_n$ is linear in $n$.
        \item There exists a term $t_n$ such that $\emptyset \vdash_2 t_n : (A_n)$.
        \item If there exists a term $u_n$ such that $\emptyset \Vdash_k u_n : A_n$, then $k \geq 2^n$.
    \end{enumerate}
\end{lemma}

\begin{proof}
    Let $\sigma_n := \bigcup\limits_{i=1}^n \{ \{a_i, b_i\} \to a_{i+1}, \{a_i, b_i\} \to b_{i+1} \}$,
    $\tau_n := \{\{a_{n+1}, b_{n+1}\} \to c\}$
    and $A_n := \{a_0, b_0\} \to \sigma_n \to \tau_n \to c$.
    \begin{enumerate}
        \item This property holds by definition.
        \item Let $v_0 := x$ and $v_{i+1} := y\,v_i$ for $i \in \{0, \ldots, n\}$.
        Let $t_n := \lambda xyz.z\,v_n$.
        We have $\emptyset \vdash_2 t_n : (A_n)$.
        The crucial step is
            \begin{displaymath}
       {\RightLabel{\textnormal{($\Rightarrow$E)}}
         \AxiomC{$\Gamma \vdash_2 y : R((a_i, b_i)) \Rightarrow (a_{i+1}, b_{i+1})$}
        \AxiomC{$\Gamma \vdash_2 v_i : (a_i, b_i)$}
        \BinaryInfC{$\Gamma \vdash_2 y\,v_i : (a_{i+1}, b_{i+1})$}
        \DisplayProof
  }
    \end{displaymath}
    Where $\Gamma = \{x: (\{a_0, b_0\}, \{a_0, b_0\}), y: (\sigma_n, \sigma_n), z: (\tau_n, \tau_n) \}$
    and $R := \{(1,1), (1,2), (2, 1),$ $(2,2)\}$, observing that $R(\Gamma) = \Gamma$.
    \item An inhabitant of $A_n$ is necessarily of shape $\lambda xyz.z\,(y \ldots (y\,x) \ldots)$ such that $y$ occurs at least $n$ times and each occurrence of $y$ doubles the annotation multiset cardinality.\qedhere
    \end{enumerate}
    
\end{proof}

Third, complementarily to the above Lemma~\ref{lem:exp_blowup_1}, there is a family of terms which are typed at a specific type $A$ in dimension $2$, but require an exponentially large multiset dimension.

\begin{lemma}\label{lem:exp_blowup_2}
    There exists a type $A$ and a family of terms $\{t_1, t_2, \ldots\}$ such that for all $n \in \mathbb{N}$:
    \begin{enumerate}
        \item The size (number of nodes in the syntax tree) of $t_n$ is linear in $n$.
        \item $\emptyset \vdash_2 t_n : (A)$.
        \item If $\emptyset \Vdash_k t_n : A$, then $k \geq 2^n$.
    \end{enumerate}
\end{lemma}

\begin{proof}
    Let $u_0 := x$ and $u_{n+1} := y\,u_n$ for $n \in \mathbb{N}$.
    Let $t_n := \lambda xyz.z\,u_n$.
    Let $\sigma := \{\{a, b\} \to a, \{a, b\} \to b\}$.
    Let $\tau := \{\{a, b\} \to c\}$.
    Let $A := \{a, b\} \to \sigma \to \tau \to c$.
    \begin{enumerate}
        \item This property holds by definition.
        \item We have $\emptyset \vdash_2 t_n : (A)$.
        The crucial step for $i \in \mathbb{N}$ is
            {\begin{displaymath}
            \RightLabel{\textnormal{($\Rightarrow$E)}}
            \AxiomC{$\Gamma \vdash_2 y : R((a, b)) \Rightarrow (a, b)$}
            \AxiomC{$\Gamma \vdash_2 u_i : (a, b)$}
            \BinaryInfC{$\Gamma \vdash_2 y\,u_i : (a, b)$}
            \DisplayProof
            \end{displaymath}}%
        Where $\Gamma := \{x: (\{a, b\}, \{a, b\}), y: (\sigma, \sigma), z: (\tau, \tau) \}$
    and $R := \{(1,1), (1,2), (2, 1), (2,2)\}$, observing that $R(\Gamma) = \Gamma$.
        \item Similarly to the proof of Lemma~\ref{lem:exp_blowup_1}, each occurrence of $y$ via the $(\cap\textnormal{I})$ rule doubles the annotation multiset cardinality.\qedhere
    \end{enumerate}
\end{proof}

The avid reader may wonder: why is the \textsf{EXPSPACE} inhabitation procedure~$\mathcal{A}_{\langle d \rangle}$~\cite{DudenhefnerR17}, which respects a bound $d$ on the multiset dimension, not suited for inhabitation in the system $(\vdash_k)$?
One immediate answer is given by the construction in the proof of Lemma~\ref{lem:exp_blowup_1}.
Iterative intersection introduction strictly increases multiset dimension.
This is reflected in procedure~$\mathcal{A}_{\langle d \rangle}$ via \emph{multisets of simultaneous constraints} with strictly increasing cardinalities on intersection introduction.

Still, the immediate answer is not satisfactory.
The construction in the proof of Lemma~\ref{lem:exp_blowup_1} can easily be accommodated for by identifying identical constraints.
The modified inhabitation procedure would remain in \textsf{EXPSPACE}.

A key property of procedure~$\mathcal{A}_{\langle d \rangle}$ is that environments in simultaneous constraints are monotone wrt.~pointwise inclusion.
That is, there is no need to strengthen type assumptions.
This is different for the system $(\vdash_k)$ for which in rule ($\Rightarrow$E) type assumptions of premises are combined, including the action of a relation $R$.
Without the monotonicity condition, the \textsf{EXPSPACE} (or, alternating exponential time) argument is not applicable.

Overall, the present notion of dimension lies between the multiset dimension (\textsf{EXPSPACE}-complete inhabitation~\cite[Theorem~34]{DudenhefnerR17}) and set dimension (undecidable inhabitation~\cite[Theorem~28]{DudenhefnerR17}), while preserving decidability of inhabitation.

\section{Conclusion}
\label{sec:conclusion}


We introduced a new syntax-directed intersection type system related to classical systems \cite{BarendregtCD83,Bakel04,Bakel11}, where typing judgments infer vectors of types rather than single types. Special relations control information flow between vector components, allowing precise tracking of information flow while keeping derivations syntax-directed and manageable. Vectors also enable a natural restriction on derivations: only types of dimension at most $k$ are allowed, which is crucial for later results.

The main motivation for this system was to obtain a formalism in which bounding a resource, here, the number of information-flow channels corresponding to vector dimension, renders inhabitation decidable. With the maximal dimension being part of the input, inhabitation is 2-EXPTIME decidable, and fixing it as a parameter yields an EXPTIME procedure. Without a bound, inhabitation becomes undecidable, as typability for such system is equivalent to strong normalizability. We also establish EXPSPACE-hardness when the maximal dimension is part of the input, leaving the exact complexity as an open problem.

An earlier system \cite{DudenhefnerR17} imposes a similar dimensional restriction. We therefore provided a detailed comparison highlighting both conceptual similarities and key differences in expressiveness and technical treatment, throughout which we are also able to see that the present system offers a simpler and cleaner framework that is easier to use in practice.

\subparagraph*{Further work} Determining the precise complexity of inhabitation in the setting of system \textbf{R} remains an open and challenging problem. Addressing it would require resolving subtle combinatorial issues that arise from the interplay of bounded resources and vector-based type structures, making this a promising direction for future research.

Another important avenue of investigation concerns type inference for system \textbf{R}. Since the system incorporates features of both set and multiset interpretations of types, it is not immediately clear whether the typability problem falls into NP or PSPACE, as established for related systems by Rehof and Dudenhefner \cite{DudenhefnerR17}. Studying this question could provide deeper insight into the algorithmic behavior of the system. As the system $\lambda^{\text{CIL}}$ by Wells et al.~\cite{WellsDMT02} was also developed in the context of type inference problems, it would be interesting to compare it with the current system on the technical level.

Finally, intersection type systems are often extended with subtyping, so developing a version of system \textbf{R} with subtyping presents another interesting direction. Such an extension could potentially support subject reduction under $\eta$-reduction, but it would also complicate the algorithmic analysis of type inference problems, requiring careful treatment to balance expressiveness and decidability.

\end{document}
